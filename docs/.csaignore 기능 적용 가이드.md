# .csaignore 기능 적용 가이드

## 개요

.csaignore 파일을 사용하여 Java 분석에서 특정 파일/폴더를 제외할 수 있는 기능이 구현되었습니다.

## 구현 완료 항목

### 1. .csaignore 예제 파일

파일: `.csaignore`

프로젝트 루트에 생성되었으며, .gitignore와 동일한 패턴 문법을 사용합니다.

**예제 패턴:**
```
# 생성된 코드 제외
**/generated/**
**/target/generated-sources/**

# DTO 클래스 제외
**/*DODT.java
**/*DIDT.java

# 특정 패키지 제외
**/com/example/legacy/**
```

### 2. csaignore.py 유틸리티 모듈

파일: `csa/utils/csaignore.py`

**주요 기능:**
- `CSAIgnoreFilter` 클래스: .csaignore 파일 파싱 및 필터링
- `load_csaignore_filter()`: 필터 로딩 함수
- pathspec 라이브러리를 사용한 .gitignore 스타일 패턴 매칭

### 3. requirements.txt 업데이트

`pathspec` 라이브러리 추가됨

**설치 방법:**
```bash
pip install -r requirements.txt
```

## project.py 통합 방법

`csa/services/java_analysis/project.py` 파일에 다음 3가지 변경이 필요합니다:

### 변경 1: import 추가

**위치:** 37번 줄 뒤

```python
from csa.utils.code_complexity import calculate_code_complexity_from_class_node
from csa.utils.csaignore import load_csaignore_filter  # <- 추가
from .config import extract_config_files
```

### 변경 2: Helper 함수 추가

**위치:** 1768번 줄 (`return stats` 와 `def parse_java_project` 사이)

```python
def _collect_java_files_with_csaignore(directory: str) -> list[str]:
    """
    디렉터리에서 .java 파일을 수집하고 .csaignore 필터를 적용합니다.

    Args:
        directory: Java 소스 디렉터리 경로

    Returns:
        list[str]: 필터링된 Java 파일 경로 목록
    """
    logger = get_logger(__name__)

    # 모든 .java 파일 수집
    java_files = []
    for root, _, files in os.walk(directory):
        for file in files:
            if file.endswith(".java"):
                java_files.append(os.path.join(root, file))

    # .csaignore 필터 적용
    csaignore_filter = load_csaignore_filter(os.getcwd())
    if csaignore_filter.has_patterns():
        logger.info(".csaignore 패턴 적용 중...")
        original_count = len(java_files)
        java_files = csaignore_filter.filter_files(java_files)
        excluded_count = original_count - len(java_files)
        if excluded_count > 0:
            logger.info(f".csaignore로 {excluded_count}개 파일 제외됨")

    return java_files
```

### 변경 3: parse_java_project_streaming() 수정

**위치:** 1383-1389번 줄

**변경 전:**
```python
    # 1회 스캔: 모든 .java 파일 경로 수집
    logger.info("Java 파일 수집 중...")
    java_files = []
    for root, _, files in os.walk(directory):
        for file in files:
            if file.endswith(".java"):
                java_files.append(os.path.join(root, file))

    total_files = len(java_files)
```

**변경 후:**
```python
    # 1회 스캔: 모든 .java 파일 경로 수집
    logger.info("Java 파일 수집 중...")
    java_files = _collect_java_files_with_csaignore(directory)

    total_files = len(java_files)
```

### 변경 4: parse_java_project_full() 수정 (첫 번째 부분)

**위치:** 727-744번 줄

**변경 전:**
```python
    # 먼저 전체 클래스 개수를 계산
    logger.info("클래스 개수 계산 중...")
    for root, _, files in os.walk(directory):
        for file in files:
            if file.endswith(".java"):
                file_path = os.path.join(root, file)
                try:
                    with open(file_path, 'r', encoding='utf-8') as f:
                        file_content = f.read()

                    tree = javalang.parse.parse(file_content)
                    for type_decl in tree.types:
                        if isinstance(type_decl, (javalang.tree.ClassDeclaration, javalang.tree.InterfaceDeclaration)):
                            total_classes += 1
                except Exception:
                    continue

    logger.info(f"총 {total_classes}개 클래스 발견")
```

**변경 후:**
```python
    # 모든 .java 파일 수집 (.csaignore 필터 포함)
    logger.info("Java 파일 수집 중...")
    java_files = _collect_java_files_with_csaignore(directory)
    logger.info(f"총 {len(java_files)}개 Java 파일 발견")

    # 먼저 전체 클래스 개수를 계산
    logger.info("클래스 개수 계산 중...")
    for file_path in java_files:
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                file_content = f.read()

            tree = javalang.parse.parse(file_content)
            for type_decl in tree.types:
                if isinstance(type_decl, (javalang.tree.ClassDeclaration, javalang.tree.InterfaceDeclaration)):
                    total_classes += 1
        except Exception:
            continue

    logger.info(f"총 {total_classes}개 클래스 발견")
```

### 변경 5: parse_java_project_full() 수정 (두 번째 부분)

**위치:** 746-750번 줄

**변경 전:**
```python
    for root, _, files in os.walk(directory):
        for file in files:
            if file.endswith(".java"):
                java_file_count += 1
                file_path = os.path.join(root, file)
                logger.debug(f"Processing Java file {java_file_count}: {file_path}")
```

**변경 후:**
```python
    for file_path in java_files:
        java_file_count += 1
        logger.debug(f"Processing Java file {java_file_count}: {file_path}")
```

## 테스트 방법

1. `.csaignore` 파일에 제외할 패턴 추가:
   ```
   **/test/**
   **/*Test.java
   ```

2. 분석 실행:
   ```bash
   python -m csa.cli.main analyze --java-object --clean --project-name myproject
   ```

3. 로그 확인:
   ```
   [INFO] .csaignore 패턴 적용 중...
   [INFO] .csaignore로 XX개 파일 제외됨
   ```

## 주의사항

- `.csaignore` 파일은 프로젝트 루트 (`.env` 파일과 같은 위치)에 있어야 합니다
- pathspec 라이브러리 설치 필요: `pip install pathspec`
- 패턴은 .gitignore와 동일한 문법 사용 (Unix 스타일 경로)
- `.csaignore` 파일은 버전 관리에 포함됩니다 (.gitignore에 없음)

## 문서 업데이트

`CLAUDE.md` 파일에 다음 섹션을 추가해야 합니다:

### 분석 대상 파일 필터링

프로젝트 루트에 `.csaignore` 파일을 생성하여 분석에서 제외할 파일/폴더를 지정할 수 있습니다.

**.csaignore 규칙:**
- .gitignore와 동일한 패턴 문법 사용
- `#`로 시작하는 줄은 주석
- `**/path/**` 패턴으로 디렉터리 제외
- `**/*Pattern.java` 패턴으로 파일명 패턴 매칭
- `!` 접두사로 예외 지정 (제외 대상에서 다시 포함)

**예제:**
```
# 생성된 코드
**/generated/**

# 대용량 DTO
**/*DODT.java
**/*DIDT.java

# 특정 패키지
**/com/example/deprecated/**

# 예외 (다시 포함)
!**/com/example/deprecated/ImportantClass.java
```

**환경 변수:**
- pathspec 라이브러리 필요: `pip install pathspec`
- `.csaignore` 파일이 없으면 모든 파일 분석 (기본 동작)
